# Welcome to secret that will help you deploy airgapped Vault and Squid Proxy to enable per-plugin access

This is a demo Terroform code **NOT** intended for production use.

It showcases the deployment of Vault cluster on AWS using:

* Raft Internal Storage
* Auto unseal Using AWS KMS
* Auto join using AWS discovery
* SSL Certificate generated by Let's Encrypt using Route53 verification

## Make Vault Airgapped

After Vault is initialized change the nodes' Security Group to be *_airgapped, it will disable all outbound communication to the internet (VPC LAN is OK)

## Configure plugin

During the provisioning gcp secrets plugin is downloaded to Vault nodes.
Run the following to enable it with the proxy.

* `PROXY_IP` is a private IP of the SQUID instance, also can be seen in terraform output.

```bash
vault plugin register -sha256=160db38375208e9bd7a3fcbc8187acd1a76c975413fdefeaa8933da44fdac1df \
  -env HTTP_PROXY="PROXY_IP:3128" \
  -env HTTPS_PROXY="PROXY_IP:3128" \
  -version="0.19.0" \
  -command=vault-plugin-secrets-gcp \
  secret gcp-proxy
```

## Enable secret engine

```bash
vault secrets enable gcp-proxy
```

## Configure it

```bash
vault write gcp-proxy/config credentials=@path_to_credentials.json
```

## Configure roleset token

```bash
vault write gcp-proxy/roleset/my-token-roleset \
    project="<PROJECT_ID>" \
    secret_type="access_token"  \
    token_scopes="https://www.googleapis.com/auth/cloud-platform" \
    bindings=-<<EOF
      resource "//cloudresourcemanager.googleapis.com/projects/<PROJECT_ID>" {
        roles = ["roles/viewer"]
      }
EOF
```

## Generate one

```bash
vault read gcp-proxy/roleset/my-token-roleset/token
```

### Thank @GuyBarros for making me do it
